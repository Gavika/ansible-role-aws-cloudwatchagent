---
- name: Setup for Ubuntu
  include_tasks: "ubuntu.yml"
  when: ansible_distribution == 'Ubuntu'

- name: Setup for CentOS
  include_tasks: "centos.yml"
  when: ansible_distribution == 'CentOS'

- name: Designate downlod directory
  set_fact:
    aws_cloudwatch_agent_download_directory: "/home/{{ aws_cloudwatch_agent_username }}/Downloads"
  when: aws_cloudwatch_agent_download_directory == ""

- name: Ensure directory to store downloaded CloudWatchAgent binary package exists
  file:
    path: "{{ aws_cloudwatch_agent_download_directory }}"
    state: directory
    owner: "{{ aws_cloudwatch_agent_username }}"
    group: "{{ aws_cloudwatch_agent_username }}"

- name: Download CloudWatchAgent
  get_url:
    url: "{{ aws_cloudwatch_agent_download_url }}"
    remote_src: true
    dest: "{{ aws_cloudwatch_agent_download_directory }}"
    owner: "{{ aws_cloudwatch_agent_username }}"
    group: "{{ aws_cloudwatch_agent_username }}"

- name: Install the package via apt
  apt:
    deb: "{{ aws_cloudwatch_agent_download_directory }}/amazon-cloudwatch-agent.deb"
  when: ansible_distribution == 'Ubuntu'

- name: Install the package via yum
  yum:
    name: "{{ aws_cloudwatch_agent_download_directory }}/amazon-cloudwatch-agent.rpm"
  when: ansible_distribution == 'CentOS'

- name: CloudWatchAgent configuration
  template:
    src: aws-cw-config.json
    dest: /opt/aws/amazon-cloudwatch-agent/bin/config.json
  register: aws_cloudwatch_agent_configuration

- name: Set the -s switch
  set_fact:
    aws_cloudwatch_agent_start_switch_value: "-s"
  when: aws_cloudwatch_agent_configuration.changed or aws_cloudwatch_agent_force_restart == true

- name: Start the CloudWatchAgent
  command: "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m {{ aws_cloudwatch_agent_mode }} -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json {{ aws_cloudwatch_agent_start_switch_value }}"
  when: aws_cloudwatch_agent_configuration.changed or aws_cloudwatch_agent_force_restart == true
